<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Companion - Patient QR Codes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">üë¥üèª Elder Companion</h1>
                    <p class="text-gray-600 text-lg">Patient Setup QR Codes</p>
                </div>
                <button onclick="loadPatients()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border-l-4 border-blue-600 p-6 mb-8 rounded-lg">
            <h2 class="text-xl font-bold text-blue-900 mb-2">üì± How to Use:</h2>
            <ol class="list-decimal list-inside text-blue-800 space-y-2">
                <li>Open your iPhone Camera app</li>
                <li>Point it at any QR code below</li>
                <li>Tap the notification that appears</li>
                <li>Your Elder Companion app will open and complete setup!</li>
            </ol>
            <p class="mt-4 text-sm text-blue-700">
                <strong>üí° Tip:</strong> Each patient has different schedules and data - perfect for testing different scenarios!
            </p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600"></div>
            <p class="mt-4 text-gray-600 text-lg">Loading patients...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-50 border-l-4 border-red-600 p-6 mb-8 rounded-lg">
            <h2 class="text-xl font-bold text-red-900 mb-2">‚ùå Error Loading Data</h2>
            <p id="error-message" class="text-red-800"></p>
            <button onclick="loadPatients()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-semibold">
                Try Again
            </button>
        </div>

        <!-- Patients Grid -->
        <div id="patients-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Patient cards will be inserted here -->
        </div>

        <!-- Stats Footer -->
        <div id="stats" class="hidden mt-8 bg-gray-800 text-white rounded-lg p-6">
            <h3 class="text-xl font-bold mb-4">üìä System Statistics</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <div class="text-3xl font-bold" id="stat-patients">0</div>
                    <div class="text-gray-400">Total Patients</div>
                </div>
                <div>
                    <div class="text-3xl font-bold" id="stat-ready">0</div>
                    <div class="text-gray-400">Ready to Setup</div>
                </div>
                <div>
                    <div class="text-3xl font-bold" id="stat-schedules">0</div>
                    <div class="text-gray-400">Total Schedules</div>
                </div>
                <div>
                    <div class="text-3xl font-bold" id="stat-reminders">0</div>
                    <div class="text-gray-400">Active Reminders</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://192.168.4.36:8000';

        async function loadPatients() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const grid = document.getElementById('patients-grid');
            const stats = document.getElementById('stats');

            // Show loading
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            grid.innerHTML = '';
            stats.classList.add('hidden');

            try {
                // Fetch all patients
                const response = await fetch(`${API_BASE}/api/v1/patients`);
                if (!response.ok) throw new Error('Failed to fetch patients');

                const patients = await response.json();

                // Filter patients with valid setup tokens
                const patientsWithTokens = patients.filter(p => p.setup_token && !p.device_setup_completed);

                // Fetch stats for each patient
                const patientsWithStats = await Promise.all(
                    patientsWithTokens.map(async (patient) => {
                        try {
                            const detailResponse = await fetch(`${API_BASE}/api/v1/patients/${patient.id}`);
                            const detail = await detailResponse.json();
                            return detail;
                        } catch (e) {
                            return patient;
                        }
                    })
                );

                // Hide loading
                loading.classList.add('hidden');

                if (patientsWithStats.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full bg-yellow-50 border-l-4 border-yellow-600 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-yellow-900 mb-2">‚ö†Ô∏è No Patients Ready for Setup</h3>
                            <p class="text-yellow-800">All patients are already setup or don't have valid setup tokens.</p>
                            <p class="text-sm text-yellow-700 mt-2">Run the seed script to create new test patients.</p>
                        </div>
                    `;
                    return;
                }

                // Render patient cards
                let totalSchedules = 0;
                let totalReminders = 0;

                patientsWithStats.forEach(patient => {
                    const scheduleCount = patient.active_schedules_count || 0;
                    const reminderCount = patient.upcoming_reminders_count || 0;
                    totalSchedules += scheduleCount;
                    totalReminders += reminderCount;

                    const card = createPatientCard(patient);
                    grid.innerHTML += card;
                });

                // Generate QR codes after cards are rendered
                patientsWithStats.forEach(patient => {
                    generateQRCode(patient.id, patient.setup_token);
                });

                // Update stats
                document.getElementById('stat-patients').textContent = patients.length;
                document.getElementById('stat-ready').textContent = patientsWithStats.length;
                document.getElementById('stat-schedules').textContent = totalSchedules;
                document.getElementById('stat-reminders').textContent = totalReminders;
                stats.classList.remove('hidden');

            } catch (err) {
                console.error('Error loading patients:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                document.getElementById('error-message').textContent = err.message;
            }
        }

        function createPatientCard(patient) {
            const qrId = `qr-${patient.id}`;
            const hasLetta = patient.letta_agent_id ? '‚úÖ' : '‚ùå';
            const scheduleCount = patient.active_schedules_count || 0;
            const reminderCount = patient.upcoming_reminders_count || 0;

            const statusColor = scheduleCount > 0 && patient.letta_agent_id ? 'green' : 'yellow';
            const statusText = scheduleCount > 0 && patient.letta_agent_id ? 'Fully Configured' : 'Needs Setup';

            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden border-2 border-${statusColor}-200">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                        <h3 class="text-2xl font-bold mb-1">${patient.full_name}</h3>
                        <p class="text-blue-100">${patient.preferred_name || 'No nickname'}</p>
                        <div class="mt-3 inline-block px-3 py-1 bg-${statusColor}-500 rounded-full text-sm font-semibold">
                            ${statusText}
                        </div>
                    </div>

                    <!-- QR Code -->
                    <div class="p-8 bg-gray-50 flex justify-center">
                        <div class="bg-white p-4 rounded-lg shadow-inner">
                            <canvas id="${qrId}" class="mx-auto"></canvas>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="p-6 border-t border-gray-200">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-600">${scheduleCount}</div>
                                <div class="text-sm text-gray-600">Schedules</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600">${reminderCount}</div>
                                <div class="text-sm text-gray-600">Reminders</div>
                            </div>
                        </div>

                        <!-- Features -->
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Letta AI Agent:</span>
                                <span class="font-semibold">${hasLetta} ${patient.letta_agent_id ? 'Active' : 'Not Set'}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Age:</span>
                                <span class="font-semibold">${patient.age || 'N/A'}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">Language:</span>
                                <span class="font-semibold">${patient.language || 'en'}</span>
                            </div>
                        </div>

                        <!-- Patient ID (for dev) -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-xs text-gray-500 font-mono break-all">
                                ID: ${patient.id}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateQRCode(patientId, setupToken) {
            const qrData = {
                patient_id: patientId,
                setup_token: setupToken
            };

            const canvas = document.getElementById(`qr-${patientId}`);
            if (canvas) {
                QRCode.toCanvas(canvas, JSON.stringify(qrData), {
                    width: 256,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) console.error('QR Code generation error:', error);
                });
            }
        }

        // Load patients on page load
        window.addEventListener('DOMContentLoaded', loadPatients);
    </script>
</body>
</html>
